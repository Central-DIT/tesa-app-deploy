
name: App Image Build, Push & Update

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      image_name:
        required: true
        type: string
      image_tag:
        required: true
        type: string
      app_info:
        required: true
        type: string
    secrets:
      azure_creds:
        required: true
      docker_env:
        required: true

jobs:
    
# ---------------------- Build Image ----------------------
  build-image:
    runs-on: ubuntu-latest
    env:
      DB_HOST: ${{ fromJson(secrets.docker_env).DB_HOST }}
      DB_PORT: ${{ fromJson(secrets.docker_env).DB_PORT }}
      DB_NAME: ${{ fromJson(secrets.docker_env).DB_NAME }}
      DB_USER: ${{ fromJson(secrets.docker_env).DB_USER }}
      DB_PASSWORD: ${{ fromJson(secrets.docker_env).DB_PASSWORD }}
      DB_SSL: ${{ fromJson(secrets.docker_env).DB_SSL }}
      PORT: ${{ fromJson(secrets.docker_env).PORT }}
      ACR_NAME: ${{ fromJson(inputs.app_info).acr_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat <<EOF > backend/.env
          DB_HOST=$DB_HOST
          DB_PORT=$DB_PORT
          DB_NAME=$DB_NAME
          DB_USER=$DB_USER
          DB_PASSWORD=$DB_PASSWORD
          DB_SSL=$DB_SSL
          PORT=$PORT
          EOF

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.azure_creds }}

      - name: Build Docker image
        run: |
          docker build \
            -t $ACR_NAME.azurecr.io/${{ inputs.image_name }}:${{ inputs.image_tag }} \
            .

      - name: Save image as artifact
        run: |
          docker save $ACR_NAME.azurecr.io/${{ inputs.image_name }}:${{ inputs.image_tag }} -o /tmp/docker-image.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/docker-image.tar

# ---------------------- Push Image ----------------------
  push-image:
    runs-on: ubuntu-latest
    needs: build-image
    env:
      ACR_NAME: ${{ fromJson(inputs.app_info).acr_name }}
    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load -i /tmp/docker-image.tar

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.azure_creds }}

      - name: Log in to ACR
        run: az acr login --name $ACR_NAME

      - name: Push Docker image
        run: |
          docker push $ACR_NAME.azurecr.io/${{ inputs.image_name }}:${{ inputs.image_tag }}

# ---------------------- Update Web App ----------------------
  update-webapp:
    runs-on: ubuntu-latest
    needs: push-image
    env:
      APP_SERVICE_NAME: ${{ fromJson(inputs.app_info).app_service_name }}
      APP_RESOURCE_GROUP: ${{ fromJson(inputs.app_info).app_resource_group }}
      ACR_NAME: ${{ fromJson(inputs.app_info).acr_name }}
    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.azure_creds }}

      - name: Update Web App Container Image
        run: |
          az webapp config container set \
            --name $APP_SERVICE_NAME \
            --resource-group $APP_RESOURCE_GROUP \
            --docker-custom-image-name $ACR_NAME.azurecr.io/${{ inputs.image_name }}:${{ inputs.image_tag }} \
            --docker-registry-server-url https://$ACR_NAME.azurecr.io

      - name: Restart Web App
        run: |
          az webapp restart \
            --name $APP_SERVICE_NAME \
            --resource-group $APP_RESOURCE_GROUP